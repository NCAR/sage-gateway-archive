<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd" logicalFilePath="/Liquibase/update/changesets/20100308-SGF-775.xml">

    <!-- Include the changes sets for this particular release -->
    <changeSet author="ncw" id="20100308-SGF-775">

        <sql>
            CREATE INDEX idx_access_point_resource_id
            ON metadata.access_point
            USING btree
            (resource_id);

            CREATE INDEX idx_annotation_resource_id
            ON metadata.annotation
            USING btree
            (resource_id);

            CREATE INDEX idx_dataset_id
            ON metadata.dataset
            USING btree
            (id);

            CREATE INDEX idx_note_resource_id
            ON metadata.note
            USING btree
            (resource_ref);

            CREATE INDEX idx_persistent_identifier_resource_id
            ON metadata.persistent_identifier
            USING btree
            (resource_id);

            CREATE INDEX idx_resource_tag_xref_resourse_id
            ON metadata.resource_tag_xref
            USING btree
            (resource_ref);

            CREATE INDEX idx_permission_resource_id
            ON "security".permission
            USING btree
            (resource_id);

            CREATE INDEX idx_model_component_resource_id
            ON curator.model_component
            USING btree
            (id);

            CREATE INDEX idx_model_component_framework_resource_id
            ON curator.model_component_framework
            USING btree
            (id);
        </sql>

        <sql>
            delete from metadata.resource where type_id=1;
        </sql>

        <addColumn schemaName="metadata" tableName="dataset_access_point">
            <column name="version" type="integer" />
            <column name="path" type="character varying(1024)" />
            <column name="full_access_url" type="text" />
            <column name="data_access_capability_id" type="uuid" />
        </addColumn>

        <sql>
            UPDATE metadata.dataset_access_point SET
            version = (SELECT version FROM metadata.access_point where access_point.id = dataset_access_point.id),
            path = (SELECT path FROM metadata.access_point where access_point.id = dataset_access_point.id),
            full_access_url = (SELECT full_access_url FROM metadata.access_point where access_point.id = dataset_access_point.id),
            data_access_capability_id = (SELECT data_access_capability_id FROM metadata.access_point where access_point.id = dataset_access_point.id);
        </sql>

        <dropForeignKeyConstraint baseTableSchemaName="metadata" baseTableName="dataset_access_point" constraintName="fkey_dataset_access_point_id"/>

        <dropTable schemaName="metadata" tableName="access_point"/>

        <sql>
            DELETE FROM metadata.resource_type where ID=1;
        </sql>

    </changeSet>

</databaseChangeLog>

